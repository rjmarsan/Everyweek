<!DOCTYPE html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<title>location1 : Built with Processing and Processing.js</title>
		<link rel="icon"  type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAQAAVzABAEAjBQAaDwYAWjUGAGE6CQBrQQ0ATS8PAFhAJwBUQC8AbFI6AHVXPACBZk4A4NrWAPb19QAAAAAAAMmZmZmZmgAJIwAAAAAAcMIjPjA+PjAKpxIuMDMzMAm0Ii4zMzMACaIiLt3dMAAJtyIuIzPQAAm0Un5yM+IzKLRkfncy4iIotRF+dyLkIiq0QX53F+EiGrQUTkd34iIatEVu7u5iIVrBVVRBRFRVbAtGZGZla2uwAMu7u7u8vADAAwAAgAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIABAADAAwAA" />
		<meta name="Generator" content="Processing" />
		<!-- - - - - - - - - - - - - - - - - - - - - 
		+
		+    Wondering how this works? 
		+
		+    Go to: http://processing.org/
		+    and: http://processingjs.org/
		+
		+ - - - - - - - - - - - - - - - - - - - - -->
		<style type="text/css">
	body {
	  background-color: #333; color: #bbb; line-height: normal;
	  font-family: Lucida Grande, Lucida Sans, Arial, Helvetica Neue, Verdana, Geneva, sans-serif;
	  font-size: 11px; font-weight: normal; text-decoration: none;
		  line-height: 1.5em;
	}
	a img { 
		border: 0px solid transparent;
	}
	a, a:link, a:visited, a:active, a:hover { 
		color: #cdcdcd; text-decoration: underline;
	}
	h1 {
	    font-family: Arial, Helvetica Neue, Verdana, Geneva, sans-serif;
		width: 100%; letter-spacing: 0.1em;
		margin-bottom: 1em; font-size: 1.65em;
	}
	canvas { 
		display: block; 
		outline: 0px; 
		margin-bottom: 1.5em; 
	}
	#content { 
		margin: 50px auto 0px auto; padding: 25px 25px 15px 25px;
		width: 800px; min-width: 300px; overflow: auto;
		border-left: 1px solid #444; border-top: 1px solid #444; 
		border-right: 1px solid #333; border-bottom: 1px solid #333;
		background-color: #3d3d3d;
		position: relative;
	}
	.hover {
		display: none;
		position: absolute;
		text-align: center;
		top: 370px;
		width: 800px;
		font-size: 1.7em;
	}
		</style>
		<!--[if lt IE 9]>
			<script type="text/javascript">alert("Your browser does not support the canvas tag.");</script>
		<![endif]-->
		<script src="processing.js" type="text/javascript"></script>
		<script src="jquery.js" type="text/javascript"></script>
		<script src="google-oauth2.js" type="text/javascript"></script>
		<script>

function getProcessing() {
  return Processing.getInstanceById('location1');
}

$(function() {
  $("#login").fadeIn();
  initGO2();
  //gethistory("ya29.AHES6ZQHcOBwkl3unZ1UkS4yPVCIC03uFMjeHGAgyDB8VAZgaM1Z1Q");
});

function initGO2() {
  GO2.init({client_id:"471207177107.apps.googleusercontent.com",
	    scope: ["https://www.googleapis.com/auth/latitude.all.best"]});
  GO2.onlogin = gethistory;
  GO2.login(false, true);
}

function hideLogin() {
  $("#login").fadeOut();
}

function startLogin() {
  GO2.login();
}

function startDemo() {
  hideLogin();
  demo();
}

downloadprogress = new Object();
downloadprogress.isdownloading = false;
downloadprogress.finished = false;

function gethistory(token) {
  console.log("LOGGED IN "+token);
  hideLogin();

  downloadprogress.isdownloading = true;
  downloadprogress.counter = 0;
  downloadprogress.eventcount = 0;
  downloadprogress.smallest = new Date().getTime();
  getHistoryUntil(token, new Date().getTime(), [], downloadprogress, function(data) {
    parse(data);
    downloadprogress.isdownloading = false;
    downloadprogress.finished = true;
  });
}

function getHistoryUntil(token, until, accumulated, progress, finished) {
  jQuery.getJSON("https://www.googleapis.com/latitude/v1/location?granularity=best&max-time="+until+"&max-results=1000&access_token="+token, function(data) {
    console.log("until: "+until);
    if (data.data.items && progress.counter < 50) {
      console.log(data);
      //data.data.items.reverse();
      var smallest = data.data.items[data.data.items.length-1].timestampMs;
      //console.log(smallest);
      progress.smallest = new Number(smallest);
      progress.eventcount = accumulated.length;
      console.log(" on the "+progress.counter+" iteration. smallest is "+smallest+" accumulated "+accumulated.length);
      progress.counter += 1;
      accumulated = accumulated.concat(data.data.items);
      getHistoryUntil(token, smallest, accumulated, progress, finished);
    } else {
      finished(accumulated);
    }
  });
}

function demo() {
  //jQuery.getJSON("latitude.json",function(data) {
  jQuery.getJSON("test.json",function(data) {
  //jQuery.getJSON("firstbatch.json",function(data) {
    data.data.items.reverse();
    parse(data.data.items);
  });
};

function finished() {
  $("#endcard").fadeIn();
}


function startAgain() {
  $("#endcard").fadeOut();
  again();
}

		</script>
		<script type="text/processing" data-processing-target="location1">


timeline = new History();
weeks = [];
weektimelines = [];
activity = [];
dataisready = false;

parse = function(data) {
  //for (var x=0; x<700; x++) data.pop();
  data.reverse();
  //console.log(data);
  processAll(data);
  console.log(data);
  //findPlaces(data, 0.003);
  //drawonce();
  weeks = makeWeekLists(data);
  while (weeks.length > 1) weeks.pop();
  console.log(weeks);
  weektimelines = makeWeekTimelines(weeks);
  timeline.setHistory(data);
  initActivity();
  initWeeks();
  dataisready = true;
};

function processAll(data) {
  for (index in data) processItem(data[index]);
}

function processItem(item) {
  var timestamp = new Number(item.timestampMs);
  //println("asdfasdf:"+timestamp);
  var date = new Date(timestamp);
  item.timestamp = floor(item.timestampMs/1000);
  item.hour = date.getHours();
  item.dayofweek = date.getDay();
  //println(date);
  //println(item.dayofweek);
  var hourofweek = item.dayofweek * 24 + item.hour;
  if (ishourweekend(hourofweek)) {
    item.weekend = 1;
    //println("WEEKENDDDDDD "+item.dayofweek);
  } else {
    item.weekend = 0;
    //println("WEEK "+item.dayofweek);
  }
//*/
}

function ishourweekend(hourofweek) {
  return hourofweek < 24 || hourofweek >= 5.7*24;
}

function makeWeekLists(history) {
  //println("Calling makeWeekLists with "+history.length);
  var current_day = 0;
  var weeks = [];
  var current_week = [];
  for (index in history) {
    var item = history[index];
    if (item.dayofweek < current_day) {
      weeks.push(current_week);
      current_week = [];
      //println("New week: "+weeks.length);
    }
    current_day = item.dayofweek;
    current_week.push(item);
  }
  weeks.push(current_week);
  return weeks;
}

function getStartOfWeek(timestamp) {
  var day = new Date(timestamp);
  day.setDate(day.getDate()-day.getDay());
  day.setHours(0,0,0);
  return day.getTime();
}

function makeWeekTimelines(weeks) {
  var timelines = [];
  for (index in weeks) {
    var week = weeks[index];
    var timeline = new History();
    timeline.setHistory(week);
    if (timeline.areAnyInRange()) {
      timelines.push(timeline);
    } else {
      //println("Have to remove week "+index);
    }
  
  }
  return timelines;
}


function initActivity() {
  activity = [];
  for (var x=0; x<24*7; x++) {
    activity.push(0);
  }
}

function initWeeks() {
  for (index in weektimelines) {
    weektimelines[index].reset();
  }
}


float getLonX(lon, left, scale) {
    return ((lon-left+scale)/scale)*width;
}
float getLatY(lat, top, scale) {
  return height-((lat-top )/scale)*height;
}
float getX(lon) {
    return getLonX(lon, g_lon, g_lon_scale);
}
float getY(lat) {
    return getLatY(lat, g_lat, g_lat_scale);
}


function History() {
  this.history = [];
  this.firsttime = 0;
  this.now = 0;
  this.currentindex = 0;
  this.curitem = 0;
  this.nextitem = 0;
  this.progress = 0;
  this.duration = 0;
  this.lastlat = -Infinity;
  this.lastlon = -Infinity;
  this.isnewlocation = 0;
  this.curlat = 0;
  this.curlon = 0;
  this.distance = 0;
}
History.prototype.setHistory = function(list) {
    this.history = list;
    this.firsttime = this.history[0].timestampMs;
    this.currentindex = 0;
    this.now = getStartOfWeek(new Number(this.firsttime));
    this.firsttime = this.now;
    console.log("First time: "+this.firsttime+ " now "+this.now);
};
History.prototype.update = function(amount) {
    this.now += amount;
    if (!this.history || this.currentindex+1 >= this.history.length) { return; }
    //println("starting update by "+amount+" now at "+this.now+" with curindex attt "+this.currentindex);
    this.isnewlocation = false;
    while (this.history[this.currentindex+1].timestampMs < this.now) {
      //println("Not there yet: "+this.currentindex+" looking for "+this.now+" and got "+history[this.currentindex+1].timestampMs);
      this.currentindex += 1;
      this.isnewlocation = true;
      if (this.currentindex+2 >= this.history.length) { return; }
    }
   // println("Calling update by "+amount+" now at "+this.now+" with curindex attt "+this.currentindex);
    this.curitem = this.history[this.currentindex];
    this.nextitem = this.history[this.currentindex+1];
    this.duration = this.nextitem.timestampMs - this.curitem.timestampMs;
    this.progress = float(this.now - this.curitem.timestampMs)/float(this.duration);
    this.lastlat = this.curlat;
    this.lastlon = this.curlon;
    this.curlat = this.getInterpLat();
    this.curlon = this.getInterpLon();
    this.distance = dist(this.lastlat, this.lastlon, this.curlat, this.curlon);
};
History.prototype.isOkToInterp = function() {
    return (this.nextitem && this.duration < 1000*60*60*6 && this.curitem.timestampMs <= this.now);
};
History.prototype.isAtEnd = function() {
    return (this.now - this.firsttime) > (1000*60*60*24*7);
};
History.prototype.reset = function() {
    this.currentindex = 0;
    this.now = this.firsttime;
};
History.prototype.getInterpLon = function() {
    var lon1 = getLonX(this.curitem.longitude, g_lon, g_lon_scale);
    var lon2 = getLonX(this.nextitem.longitude, g_lon, g_lon_scale);
    var curlon = lerp(lon1, lon2, this.progress);
    return curlon;
};
History.prototype.getInterpLat = function() {
    var lat1 = getLatY(this.curitem.latitude, g_lat, g_lat_scale);
    var lat2 = getLatY(this.nextitem.latitude, g_lat, g_lat_scale);
    var curlat = lerp(lat1, lat2, this.progress);
    return curlat;
};

History.prototype.areAnyInRange = function() {
    for (i in this.history) {
      var x = getX(this.history[i].longitude);
      var y = getY(this.history[i].latitude);
      if (x > 0 && x < width && y > 0 && y < height)
	return true;
    }
    return false;
};

History.prototype.isInRange = function() {
    var x = this.curlat;//getX(this.curitem.longitude);
    var y = this.curlon;//getY(this.curitem.latitude);
    if (x > 0 && x < width && y > 0 && y < height)
      return true;
    else
      return false;
};


















/*******
THE TODO

DONE /getStartOfWeek so they all start on time!

make week markers into TRAILS so they don't zip by into infinity
Time of the week indication to show when through the week it's at

******/



/** globals **/
snapshot = function() {
  //var pngUrl = externals.canvas.toDataURL("image/png;base64");
  //var rawImageData = pngUrl.replace("image/png", "image/octet-stream")
  //document.location.href = rawImageData;
  //console.log(pngUrl);
  save();
}


again = function() {
  setup();
}


g_lon = -88.2; //12;
g_lon_scale = 0.05; //2;
g_lat = 40.077; //05;
g_lat_scale = 0.05; //2;


dist = dist;





History currentweek;
PGraphics places_graphics;
PGraphics me_secondary;
PGraphics me_graphics;
float UPDATE_TIME = 1000*60*10;
//UPDATE_TIME *= 4;
int max_weeks = 1;
PFont font;
boolean alldone;

color weekendcolor = #669900;
color weekdaycolor = #0099cc;
color indicatorcolor = #ffdd22;
color othercolor = #FFFFFF;

void setup() {
  size(800,800, P2D);
  smooth();
  //frameRate(2);
  frameRate(30);
  places_graphics = createGraphics(width,height, P2D);
  me_secondary = createGraphics(width,height, P2D);
  me_secondary.beginDraw();
  me_secondary.background(250);
  me_secondary.endDraw();
  me_graphics = createGraphics(width,height, P2D);
  font = loadFont("Courier New");
  textFont(font, 36);
  max_weeks = 1;
  setupData();
  alldone = false;
}

void setupData() {
  initActivity();
  timeline.reset();
  initWeeks();
}

void draw() {
  if (alldone) {
    drawAnimation(true);
  } else if (dataisready && weektimelines.length > 0) {
    updateTime();
    drawAnimation(false);
  } else {
    background(0);
    drawLoading();
  }
}

void drawAnimation(boolean prettyup) {
  background(0);
  //drawPlaces(lg);
  drawMovement(me_graphics, me_secondary, prettyup);
  drawHistory(places_graphics, prettyup);
  drawMeWeek(prettyup);
  drawTimeline(prettyup);
}

void drawFps() {
  fill(255, 0, 0);
  //ellipse(30,30,int(frameCount)%25, int(frameCount)%25);
}

void drawLoading() {
  pushStyle();
  fill(othercolor, 100);
  textFont(font, 36);
  textAlign(CENTER,CENTER);
  if (downloadprogress.isdownloading) {
    text("Going back in time...", width/2, height/2);
    textFont(font, 20);
    text(""+new Date(downloadprogress.smallest).toDateString()+" - now ("+downloadprogress.eventcount+" events)", width/2, height/2+36);
  } else if (downloadprogress.finished) {
    text("Thinking...", width/2, height/2);
  } else {

  }
  popStyle();
}

void updateTime() {
  if (timeline && weektimelines.length > 0) {
    //println("Time now: "+timeline.now+" and history: "+timeline.history[0].timestampMs);
    if (max_weeks == 1 && timeline.now < timeline.history[0].timestampMs) {
      //SPECIAL BEHAVIOR
      long distuntilstart = timeline.history[0].timestampMs - timeline.now;
      //println("Special behavior. jumping "+distuntilstart+ " from "+timeline.now+ " to "+timeline.history[0].timestampMs);
      timeline.update(distuntilstart);
      weektimelines[0].update(distuntilstart);
    }
    boolean isdone = false;
    timeline.update(UPDATE_TIME);
    for (index in weektimelines) {
      if (index < max_weeks) {
	History tl = weektimelines[index];
	tl.update(UPDATE_TIME); //30 minutes

	if (tl.isAtEnd()) {
	  tl.reset();
	  isdone = true;
	  finished();
	}
      }
    }
    currentweek = weektimelines[max_weeks - 1];
    if (currentweek.distance < 100000 && currentweek.isInRange()) {
      //don't add if we fly somewhere. then we look very active.
      var day = new Date(timeline.now);
      int index = day.getDay()*24 + day.getHours();
      activity[index] += currentweek.distance;
    }
    if (isdone) {
      max_weeks += 1;
      //println("New week: "+max_weeks);
      if (max_weeks > weektimelines.length) {
	alldone = true;
      }
    }
  }

}

int lasthistory;
int numcircles = 0;
void drawHistory(PGraphics p, boolean prettyup) {
  if (prettyup) {
    image(p, 0, 0);
    return; //we don't do anything;
  }
  History timeline = currentweek;//weektimelines[max_weeks-1];
  p.beginDraw();
  if (timeline.curitem && (timeline.isnewlocation || lasthistory >= 1) ) {
    float lon, lat;
    lon = getX(timeline.curitem.longitude);
    lat = getY(timeline.curitem.latitude);
    p.noStroke();
    if (timeline.curitem.weekend) {
      p.fill(weekendcolor,5);
    } else {
      p.fill(weekdaycolor,5);
    }
    //float radius = 2+pow(1.5, random(-120, 12));
    float radius = 2+pow(1.5, random(-120, 12));
    //float radius = 2+pow(2, random(-30,6));
    p.ellipse(lon,lat, radius, radius);
    if (timeline.curitem.weekend) {
      p.fill(weekendcolor,30);
    } else {
      p.fill(weekdaycolor,30);
    }
    p.ellipse(lon,lat, 3, 3); 
    lasthistory = 0;
    numcircles += 1;
    //println("Num circles: "+numcircles);
  } else {
    lasthistory += 1; //CHANGE BACK
  }

  p.endDraw();
  image(p, 0, 0);

}


void drawMovement(PGraphics p, PGraphics p2, boolean prettyup) {
  if (prettyup) {
    p.beginDraw();
    p.noStroke();
    p.fill(0,0,0,10);
    p.rect(0,0,p.width,p.height);
    p.endDraw();
    image(p, 0, 0);
    return;
  }
  p.beginDraw();
  p.noStroke();
  p.fill(0,0,0,10);
  p.rect(0,0,p.width,p.height);
  //p.blend(p2, 0, 0, width, height, 0, 0, width, height, BLEND);
  //p.alpha(1);
  for (index in weektimelines) {
    if (index < max_weeks) {
      History timeline = weektimelines[index];
      if (timeline.isOkToInterp()) {
	float curlon = timeline.curlon;
	float curlat = timeline.curlat;
	if (index == max_weeks-1) {
	  p.stroke(indicatorcolor, 20);
	  p.strokeWeight(4);
	} else {
	  p.stroke(indicatorcolor, 15);
	  p.strokeWeight(1);
	}
	float lastlat = timeline.lastlat;
	float lastlon = timeline.lastlon;
	if (timeline.isnewlocation) {
	  float loclon = getX(timeline.curitem.longitude);
	  float loclat = getY(timeline.curitem.latitude);
	  p.line(lastlon,lastlat, loclon, loclat);
	  p.line(loclon, loclat, curlon, curlat);
	} else {
	  p.line(lastlon, lastlat, curlon, curlat);
	}
      }
    }
  }
  p.endDraw();
  image(p, 0, 0);
}



void drawMeWeek(boolean prettyup) {
  if (prettyup) return; //don't even want to show this here.
  pushStyle();
  rectMode(CENTER);
  noStroke();
  stroke(0, 0, 0, 60);
  for (index in weektimelines) {
    if (index < max_weeks) {
      History timeline = weektimelines[index];
      if (timeline.isOkToInterp()) {
	float curlon = timeline.curlon;
	float curlat = timeline.curlat;
	if (index == max_weeks-1) {
	  fill(indicatorcolor, 200);
	  ellipse(curlon, curlat, 7,7);
	} else {
	  fill(indicatorcolor, 100);
	  ellipse(curlon, curlat, 7,7);
	}

	timeline.lastlat = curlat;
	timeline.lastlon = curlon;
      }
    }
  }
  popStyle();
}

void drawTimeline(boolean prettyup) {
  if (!weektimelines || weektimelines.length <= 0) return;
  long nowms = weektimelines[0].now;
  long amountthrough = nowms - weektimelines[0].firsttime;
  float percentthrough = amountthrough / (1000*60*60*24*7.0);
  var nowdate = new Date(nowms);
  String day = getDayText(nowdate.getDay());



  float spaceh = 50;
  float spacing = width/7;
  fill(othercolor, 100);
  textAlign(RIGHT,BOTTOM);
  if (prettyup) {
    long start = weektimelines[0].history[0].timestampMs;
    History endweek = weektimelines[weektimelines.length-1];
    long end = endweek.history[endweek.history.length-1].timestampMs;
    text(new Date(start).toDateString()+" - "+new Date(end).toDateString(),width-15,height-spaceh-10);
  } else {
    text(day+ " - Week "+min(max_weeks, weektimelines.length),width-15,height-spaceh-10);
    //println("::: = "+getDayText(nowdate.getDay())+" at "+nowdate.toTimeString());
  }


  noStroke();
  fill(weekendcolor, 20);
  //rect(0, height-spaceh, spacing,spaceh);
  //rect(spacing*(7-1.3), height-spaceh, spacing*1.3, spaceh);
  fill(weekdaycolor, 20);
  //rect(spacing*1, height-spaceh, spacing*(7-2.3), spaceh);
  fill(othercolor, 8);
  rect(0, height-spaceh, width, spaceh);
  stroke(othercolor, 50);
  for (int i=1; i<7; i++) {
    line(spacing*i, height-spaceh, spacing*i, height);
  }
  
  noStroke();
  float maxactivity = max(activity);
  float hourspace = width/(7*24);
  rectMode(CORNERS);
  for (int i=0; i<activity.length; i++) {
    if (ishourweekend(i)) 
      fill(weekendcolor, 70);
    else
      fill(weekdaycolor, 70);
    float val = activity[i];
    val = val/maxactivity * spaceh;
    rect(floor((i)*hourspace), height-val, floor((i+1)*hourspace), height);
  }

  rectMode(CORNER);
  if (!prettyup) {
    stroke(indicatorcolor,160);
    line(width*percentthrough, height-spaceh*0.7, width*percentthrough, height);
  }
}


function getDayText(int day) {
  if (day == 0) {
    return "Sunday";
  } else if (day == 1) {
    return "Monday";
  } else if (day == 2) {
    return "Tuesday";
  } else if (day == 3) {
    return "Wednesday";
  } else if (day == 4) {
    return "Thursday";
  } else if (day == 5) {
    return "Friday";
  } else if (day == 6) {
    return "Saturday";
  }


}


		</script>

	</head>
	<body>
		<div id="content">
			<div>
				<canvas id="location1" width="800" height="800">
					<p>Your browser does not support the canvas tag.</p>
					<!-- Note: you can put any alternative content here. -->
				</canvas>
				<noscript>
					<p>JavaScript is required to view the contents of this page.</p>
				</noscript>
				<div id="login" class="hover">
				  <p>
				  Want to visualize your habits? -  <a href="javascript:startLogin()">Log In Using Google Latitude</a> to try it out.
				  </p>
				  <p>
				  Want to see a demo? <a href="javascript:startDemo()">Watch</a>
				  </p>
				</div>
				<div id="endcard" class="hover">
				  <p> <a href="javascript:startAgain()">Again</a> <a href="javascript:snapshot()">Download</a></p>
				</div>
	    	</div>
		<div>
			<h1>Location Visualization</h1>
			<!--<div id="screenshot"> <a href="javascript:snapshot()">take a screenshot</a> </div> -->
			<p id="description">
			  See your location habits. Log in using google latitude to see the patterns of places you go with the patterns of when you're active.
			</p>
			<p>
			Built with <a href="http://processing.org" title="Processing">Processing</a>
			and <a href="http://processingjs.org" title="Processing.js">Processing.js</a>
			</p>
		</div>
	</body>
</html>
